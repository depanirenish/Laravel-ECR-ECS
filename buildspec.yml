version: 0.2

phases:
  install:
    commands:
      - echo "Installing dependencies"
      - apt-get update
      - apt-get install -y amazon-ecr-credential-helper

  pre_build:
    commands:
      - echo "Logging in to Amazon ECR"
      - $(aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 645095421007.dkr.ecr.us-east-1.amazonaws.com)
      - echo "Pulling latest image"
      - docker pull $645095421007.dkr.ecr.us-east-1.amazonaws.com/laravel_rds:latest || true

  build:
    commands:
      - echo "Building the Docker image"
      - docker build -t laravel_rds .
      - docker tag laravel_rds:latest 645095421007.dkr.ecr.us-east-1.amazonaws.com/laravel_rds:latest

  post_build:
    commands:
      - echo "Pushing the Docker image to ECR"
      - docker push 645095421007.dkr.ecr.us-east-1.amazonaws.com/laravel_rds:latest
      - echo "Updating ECS service"
      - aws ecs update-service --cluster laravel-rds --service $ECS_SERVICE --force-new-deployment
artifacts:
  files:
    - '**/*'
